#!/bin/bash
# Validates conventional commits format: type(scope): message
# Types: feat, fix, refactor, docs, test, chore, style, perf, ci, build, revert

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge (branch|pull request|remote-tracking)"; then
    exit 0
fi

# Skip revert commits (auto-generated by git)
if echo "$COMMIT_MSG" | grep -qE "^Revert \""; then
    exit 0
fi

# Conventional commit pattern:
# type(scope): message   OR   type: message
# - type is required (lowercase)
# - scope is optional
# - colon and space after type/scope
# - message starts with lowercase (recommendation, not enforced)
PATTERN="^(feat|fix|refactor|docs|test|chore|style|perf|ci|build|revert)(\([a-z0-9_-]+\))?: .+"

if ! echo "$COMMIT_MSG" | head -1 | grep -qE "$PATTERN"; then
    echo ""
    echo "❌ COMMIT MESSAGE REJECTED"
    echo ""
    echo "   Your message:"
    echo "   $(head -1 "$COMMIT_MSG_FILE")"
    echo ""
    echo "   Expected format: type(scope): message"
    echo ""
    echo "   Valid types: feat, fix, refactor, docs, test, chore, style, perf, ci, build, revert"
    echo ""
    echo "   Examples:"
    echo "     feat(api): add year fetching endpoint"
    echo "     fix(cache): prevent duplicate writes"
    echo "     refactor(core): extract scoring logic"
    echo "     docs: update CLAUDE.md with testing strategy"
    echo ""
    exit 1
fi

# Check subject line length (hard limit: 55 chars per skill)
SUBJECT_LENGTH=$(head -1 "$COMMIT_MSG_FILE" | wc -c)
# Note: wc -c includes trailing newline, so actual limit is 56
if [ "$SUBJECT_LENGTH" -gt 56 ]; then
    echo ""
    echo "❌ COMMIT REJECTED: Subject exceeds 55 characters ($((SUBJECT_LENGTH - 1)) chars)"
    echo ""
    echo "   Your subject: $(head -1 "$COMMIT_MSG_FILE")"
    echo ""
    echo "   Tip: Move details to commit body, keep subject concise"
    echo ""
    exit 1
fi
