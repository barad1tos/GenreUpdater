name: Mutation Testing Pipeline

on:
  # Weekly schedule (Sunday at 02:00 UTC) - primary trigger
  schedule:
    - cron: '0 2 * * 0'

  # Run after PR is merged to main (optional, for immediate feedback)
  push:
    branches: [main]
    paths:
      - 'src/**/*.py'
      - 'tests/**/*.py'

  # Run when PR is approved
  pull_request_review:
    types: [submitted]

  # Manual trigger
  workflow_dispatch:
    inputs:
      module:
        description: 'Override: test specific module pattern (e.g., "core.config*")'
        required: false
        default: ''
      force_full:
        description: 'Force full src/ test (ignores incremental)'
        type: boolean
        default: false

concurrency:
  group: mutation-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Stage 1: Wait for CI to pass
  # ═══════════════════════════════════════════════════════════════════════════
  wait-for-ci:
    name: "1. Wait for CI"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved')
    outputs:
      should_continue: ${{ steps.check.outputs.continue }}
    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          check-regexp: '^(Lint & Type Check|Tests)$'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success
          running-workflow-name: 'Mutation Testing Pipeline'

      - name: Set continue flag
        id: check
        run: echo "continue=true" >> $GITHUB_OUTPUT

  # ═══════════════════════════════════════════════════════════════════════════
  # Stage 2: Run Mutation Testing with mutmut
  # ═══════════════════════════════════════════════════════════════════════════
  mutation-test:
    name: "2. Mutation Testing"
    runs-on: ubuntu-latest
    needs: wait-for-ci
    # 20 min for incremental, 60 min for full (weekly)
    timeout-minutes: ${{ github.event_name == 'schedule' && 60 || 20 }}
    outputs:
      score: ${{ steps.results.outputs.score }}
      killed: ${{ steps.results.outputs.killed }}
      survived: ${{ steps.results.outputs.survived }}
      total: ${{ steps.results.outputs.total }}
      skipped: ${{ steps.changed.outputs.skip }}
      mode: ${{ steps.changed.outputs.mode }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get changed Python files
        id: changed
        run: |
          echo "=== Detecting changed files ==="

          # Check for force full or schedule trigger
          if [ "${{ github.event.inputs.force_full || 'false' }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            echo "Full src/ mutation test requested"
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "modules=" >> $GITHUB_OUTPUT  # Empty = all modules
            echo "mode=full" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for manual module override
          if [ -n "${{ github.event.inputs.module }}" ]; then
            echo "Manual module override: ${{ github.event.inputs.module }}"
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "modules=${{ github.event.inputs.module }}" >> $GITHUB_OUTPUT
            echo "mode=override" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Incremental: get changed Python files and convert to module patterns
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FILES=$(git diff --name-only --diff-filter=ACMRT HEAD~1 HEAD -- 'src/**/*.py' 2>/dev/null || echo "")
          else
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
              FILES=$(git diff --name-only --diff-filter=ACMRT HEAD~1 HEAD -- 'src/**/*.py' 2>/dev/null || echo "")
            else
              FILES=$(git diff --name-only --diff-filter=ACMRT "$BEFORE" "$AFTER" -- 'src/**/*.py' 2>/dev/null || echo "")
            fi
          fi

          if [ -z "$FILES" ]; then
            echo "No Python source files changed in src/"
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "mode=skipped" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$FILES"

            # Convert file paths to mutmut module patterns
            # src/core/config.py -> core.config*
            MODULES=$(echo "$FILES" | while read -r f; do
              # Remove src/ prefix and .py suffix, replace / with .
              echo "$f" | sed 's|^src/||' | sed 's|\.py$|*|' | sed 's|/|.|g'
            done | sort -u | tr '\n' ' ')

            echo "Module patterns: $MODULES"
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "modules=$MODULES" >> $GITHUB_OUTPUT
            echo "mode=incremental" >> $GITHUB_OUTPUT
          fi

      - name: Install uv
        if: steps.changed.outputs.skip != 'true'
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        if: steps.changed.outputs.skip != 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install dependencies
        if: steps.changed.outputs.skip != 'true'
        run: uv sync

      - name: Run mutation testing
        if: steps.changed.outputs.skip != 'true'
        id: mutmut
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        run: |
          MODULES="${{ steps.changed.outputs.modules }}"
          MODE="${{ steps.changed.outputs.mode }}"

          echo "=== Running mutmut (mode: $MODE) ==="
          echo "PYTHONPATH: $PYTHONPATH"

          # Clean previous results
          rm -rf mutants/

          if [ -z "$MODULES" ]; then
            # Full run - test all src/
            echo "Running full mutation test on src/"
            uv run mutmut run
          else
            # Incremental - test specific modules
            echo "Running mutation test on: $MODULES"
            for module in $MODULES; do
              echo "Testing module pattern: $module"
              uv run mutmut run "$module"
            done
          fi

      - name: Extract results
        id: results
        if: steps.changed.outputs.skip != 'true'
        run: |
          echo "=== Extracting mutation results ==="

          # Get results using mutmut show (more reliable output)
          # mutmut show all returns: "1-10" format for killed, etc.
          RESULTS=$(uv run mutmut results 2>/dev/null || echo "")

          if [ -z "$RESULTS" ] || echo "$RESULTS" | grep -q "No mutants"; then
            echo "No mutation results found"
            echo "score=0" >> $GITHUB_OUTPUT
            echo "killed=0" >> $GITHUB_OUTPUT
            echo "survived=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Raw results:"
          echo "$RESULTS"
          echo "---"

          # Count by status - ensure single integer output
          KILLED=$(echo "$RESULTS" | grep -c "killed" 2>/dev/null || true)
          KILLED=${KILLED:-0}
          KILLED=$(echo "$KILLED" | tr -d '[:space:]')

          SURVIVED=$(echo "$RESULTS" | grep -c "survived" 2>/dev/null || true)
          SURVIVED=${SURVIVED:-0}
          SURVIVED=$(echo "$SURVIVED" | tr -d '[:space:]')

          TIMEOUT=$(echo "$RESULTS" | grep -c "timeout" 2>/dev/null || true)
          TIMEOUT=${TIMEOUT:-0}
          TIMEOUT=$(echo "$TIMEOUT" | tr -d '[:space:]')

          SUSPICIOUS=$(echo "$RESULTS" | grep -c "suspicious" 2>/dev/null || true)
          SUSPICIOUS=${SUSPICIOUS:-0}
          SUSPICIOUS=$(echo "$SUSPICIOUS" | tr -d '[:space:]')

          NOT_CHECKED=$(echo "$RESULTS" | grep -c "not checked" 2>/dev/null || true)
          NOT_CHECKED=${NOT_CHECKED:-0}
          NOT_CHECKED=$(echo "$NOT_CHECKED" | tr -d '[:space:]')

          # Ensure all values are valid integers
          [ -z "$KILLED" ] && KILLED=0
          [ -z "$SURVIVED" ] && SURVIVED=0
          [ -z "$TIMEOUT" ] && TIMEOUT=0
          [ -z "$SUSPICIOUS" ] && SUSPICIOUS=0
          [ -z "$NOT_CHECKED" ] && NOT_CHECKED=0

          echo "Parsed: killed=$KILLED, survived=$SURVIVED, timeout=$TIMEOUT"

          # Total tested = killed + survived + timeout + suspicious
          TOTAL=$((KILLED + SURVIVED + TIMEOUT + SUSPICIOUS))

          # Calculate score (killed / total * 100)
          if [ "$TOTAL" -gt 0 ]; then
            SCORE=$(echo "scale=2; $KILLED * 100 / $TOTAL" | bc)
          else
            SCORE="0"
          fi

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "killed=$KILLED" >> $GITHUB_OUTPUT
          echo "survived=$SURVIVED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # Write summary
          echo "### Mutation Results" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Score | **${SCORE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| Killed | $KILLED |" >> $GITHUB_STEP_SUMMARY
          echo "| Survived | $SURVIVED |" >> $GITHUB_STEP_SUMMARY
          echo "| Timeout | $TIMEOUT |" >> $GITHUB_STEP_SUMMARY
          echo "| Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY

          if [ "$NOT_CHECKED" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Note:** $NOT_CHECKED mutants were not checked (timeout or skipped)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "Score: ${SCORE}%, Killed: $KILLED, Survived: $SURVIVED, Total: $TOTAL"

  # ═══════════════════════════════════════════════════════════════════════════
  # Stage 3: Update Metrics & Detect Trends
  # ═══════════════════════════════════════════════════════════════════════════
  update-metrics:
    name: "3. Update Metrics"
    runs-on: ubuntu-latest
    needs: mutation-test
    if: needs.mutation-test.outputs.skipped != 'true'
    timeout-minutes: 10
    outputs:
      trend: ${{ steps.analyze.outputs.trend }}
      trend_value: ${{ steps.analyze.outputs.trend_value }}
      regression: ${{ steps.analyze.outputs.regression }}

    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Load current history
        id: load
        run: |
          if [ -f docs/mutation-dashboard/history.json ]; then
            cat docs/mutation-dashboard/history.json
          else
            echo "[]"
          fi > /tmp/history.json

      - name: Append new result
        run: |
          NEW_ENTRY=$(cat << EOF
          {
            "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "score": ${{ needs.mutation-test.outputs.score }},
            "killed": ${{ needs.mutation-test.outputs.killed }},
            "survived": ${{ needs.mutation-test.outputs.survived }},
            "total": ${{ needs.mutation-test.outputs.total }},
            "module": "${{ needs.mutation-test.outputs.mode || 'unknown' }}"
          }
          EOF
          )

          python3 << PYTHON
          import json

          with open('/tmp/history.json', 'r') as f:
              history = json.load(f)

          new_entry = json.loads('''${NEW_ENTRY}''')
          history.append(new_entry)

          # Keep last 100 entries
          history = history[-100:]

          with open('/tmp/history.json', 'w') as f:
              json.dump(history, f, indent=2)
          PYTHON

      - name: Analyze trends
        id: analyze
        run: |
          python3 << 'PYTHON'
          import json
          import os

          with open('/tmp/history.json', 'r') as f:
              history = json.load(f)

          if len(history) < 2:
              trend = "baseline"
              trend_value = 0
              regression = "false"
          else:
              current = history[-1]['score']
              previous = history[-2]['score']
              diff = current - previous

              if diff > 1:
                  trend = "improvement"
              elif diff < -1:
                  trend = "regression"
              else:
                  trend = "stable"

              trend_value = round(diff, 2)

              # Check for significant regression (>5% drop)
              regression = "true" if diff < -5 else "false"

              # Also check against 5-run average
              if len(history) >= 6:
                  prev_5 = history[-6:-1]
                  avg_5 = sum(h['score'] for h in prev_5) / len(prev_5)
                  if current < avg_5 - 5:
                      regression = "true"

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"trend={trend}\n")
              f.write(f"trend_value={trend_value}\n")
              f.write(f"regression={regression}\n")

          print(f"Trend: {trend} ({trend_value:+.2f}%)")
          print(f"Regression detected: {regression}")
          PYTHON

      - name: Update dashboard
        run: |
          cp /tmp/history.json docs/mutation-dashboard/history.json

      - name: Commit & push metrics
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/mutation-dashboard/history.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(metrics): update mutation score [${{ needs.mutation-test.outputs.score }}%]

            Score: ${{ needs.mutation-test.outputs.score }}%
            Killed: ${{ needs.mutation-test.outputs.killed }}
            Survived: ${{ needs.mutation-test.outputs.survived }}
            Trend: ${{ steps.analyze.outputs.trend }} (${{ steps.analyze.outputs.trend_value }}%)"

            git pull --rebase origin main
            git push
          fi

      - name: Generate trend summary
        run: |
          TREND="${{ steps.analyze.outputs.trend }}"
          TREND_VAL="${{ steps.analyze.outputs.trend_value }}"
          REGRESSION="${{ steps.analyze.outputs.regression }}"

          echo "### Trend Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TREND" = "improvement" ]; then
            echo "#### :chart_with_upwards_trend: Improvement (+${TREND_VAL}%)" >> $GITHUB_STEP_SUMMARY
          elif [ "$TREND" = "regression" ]; then
            echo "#### :chart_with_downwards_trend: Regression (${TREND_VAL}%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "#### :arrow_right: Stable" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$REGRESSION" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo ":warning: **Significant regression detected!** Review test quality." >> $GITHUB_STEP_SUMMARY
          fi

  # ═══════════════════════════════════════════════════════════════════════════
  # Stage 4: Decision & Actions
  # ═══════════════════════════════════════════════════════════════════════════
  decision:
    name: "4. Decision"
    runs-on: ubuntu-latest
    needs: [mutation-test, update-metrics]
    timeout-minutes: 5
    if: always() && needs.mutation-test.result == 'success' && needs.mutation-test.outputs.skipped != 'true'

    steps:
      - name: Evaluate results
        id: evaluate
        run: |
          SCORE="${{ needs.mutation-test.outputs.score }}"
          TREND="${{ needs.update-metrics.outputs.trend }}"
          REGRESSION="${{ needs.update-metrics.outputs.regression }}"

          echo "### Decision Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Validate SCORE is numeric
          if ! [[ "$SCORE" =~ ^[0-9]+\.?[0-9]*$ ]]; then
            echo "Warning: Invalid score '$SCORE', defaulting to 0"
            SCORE="0"
          fi

          # Check 1: Minimum score threshold
          if (( $(echo "$SCORE >= 60" | bc -l) )); then
            echo "| Score >= 60% | :white_check_mark: Pass |" >> $GITHUB_STEP_SUMMARY
            SCORE_OK="true"
          else
            echo "| Score >= 60% | :x: Fail ($SCORE%) |" >> $GITHUB_STEP_SUMMARY
            SCORE_OK="false"
          fi

          # Check 2: No significant regression
          if [ "$REGRESSION" = "false" ]; then
            echo "| No regression | :white_check_mark: Pass |" >> $GITHUB_STEP_SUMMARY
            REGRESSION_OK="true"
          else
            echo "| No regression | :warning: Warning |" >> $GITHUB_STEP_SUMMARY
            REGRESSION_OK="false"
          fi

          # Final decision
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$SCORE_OK" = "true" ] && [ "$REGRESSION_OK" = "true" ]; then
            echo "#### :rocket: All checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "action=none" >> $GITHUB_OUTPUT
          elif [ "$SCORE_OK" = "false" ]; then
            echo "#### :x: Action required: Improve test quality" >> $GITHUB_STEP_SUMMARY
            echo "action=improve_tests" >> $GITHUB_OUTPUT
          else
            echo "#### :warning: Review recommended: Regression detected" >> $GITHUB_STEP_SUMMARY
            echo "action=review" >> $GITHUB_OUTPUT
          fi

      - name: Create issue on regression
        if: needs.update-metrics.outputs.regression == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const score = '${{ needs.mutation-test.outputs.score }}';
            const trendValue = '${{ needs.update-metrics.outputs.trend_value }}';
            const commit = '${{ github.sha }}'.substring(0, 7);
            const issueTitle = `Mutation score regression detected (${trendValue}%)`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'mutation-regression',
              state: 'open'
            });

            const isDuplicate = issues.data.some(issue => {
              const titleMatch = issue.title.includes('regression detected');
              const commitMatch = issue.body && issue.body.includes(commit);
              return titleMatch || commitMatch;
            });

            if (isDuplicate) {
              console.log('Similar regression issue already exists, skipping creation');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: `## Mutation Testing Regression Alert

            | Metric | Value |
            |--------|-------|
            | Current Score | ${score}% |
            | Change | ${trendValue}% |
            | Commit | ${commit} |

            ### Recommended Actions
            1. Review recent test changes
            2. Check for removed assertions
            3. Run mutation testing locally to identify weak tests
            4. Add missing test cases for surviving mutants

            [View Dashboard](https://${context.repo.owner}.github.io/${context.repo.repo}/mutation-dashboard/)
            `,
              labels: ['mutation-regression', 'testing', 'automated']
            });
            console.log('Created regression issue');

      - name: Post PR comment
        if: github.event_name == 'pull_request_review'
        uses: actions/github-script@v8
        with:
          script: |
            const score = '${{ needs.mutation-test.outputs.score }}';
            const killed = '${{ needs.mutation-test.outputs.killed }}';
            const survived = '${{ needs.mutation-test.outputs.survived }}';
            const trend = '${{ needs.update-metrics.outputs.trend }}';
            const trendValue = '${{ needs.update-metrics.outputs.trend_value }}';

            const trendEmoji = trend === 'improvement' ? ':chart_with_upwards_trend:' :
                              trend === 'regression' ? ':chart_with_downwards_trend:' : ':arrow_right:';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.review.pull_request.number,
              body: `## Mutation Testing Results

            | Metric | Value |
            |--------|-------|
            | **Score** | ${score}% |
            | Killed | ${killed} |
            | Survived | ${survived} |
            | Trend | ${trendEmoji} ${trendValue}% |

            [View Dashboard](https://${context.repo.owner}.github.io/${context.repo.repo}/mutation-dashboard/)
            `
            });
