name: Diagnose Year Lookup Failures

on:
  # Trigger when pending_year_verification.csv is updated
  push:
    branches: [main, dev]
    paths:
      - 'tests/fixtures/pending_year_verification.csv'

  # Manual trigger
  workflow_dispatch:
    inputs:
      max_albums:
        description: 'Max albums to diagnose'
        required: false
        default: '20'
      create_issues:
        description: 'Create GitHub issues'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  # Weekly schedule (Sunday 10:00 UTC)
  schedule:
    - cron: '0 10 * * 0'

jobs:
  diagnose:
    name: Diagnose & Create Issues
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: uv sync

      - name: Check pending albums count
        id: check
        run: |
          PENDING_FILE="tests/fixtures/pending_year_verification.csv"
          if [[ ! -f "$PENDING_FILE" ]]; then
            echo "No pending file found"
            echo "has_pending=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Count lines (minus header)
          COUNT=$(($(wc -l < "$PENDING_FILE") - 1))
          echo "Found $COUNT pending albums"
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          if [[ $COUNT -gt 0 ]]; then
            echo "has_pending=true" >> $GITHUB_OUTPUT
          else
            echo "has_pending=false" >> $GITHUB_OUTPUT
          fi

      - name: Run diagnostics
        if: steps.check.outputs.has_pending == 'true'
        env:
          DISCOGS_TOKEN: ${{ secrets.DISCOGS_TOKEN }}
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          CONTACT_EMAIL: ${{ secrets.CONTACT_EMAIL }}
          MAX_ALBUMS_INPUT: ${{ github.event.inputs.max_albums || '20' }}
        run: |
          # Sanitize input - only allow digits
          MAX_ALBUMS=$(echo "$MAX_ALBUMS_INPUT" | tr -cd '0-9')
          MAX_ALBUMS=${MAX_ALBUMS:-20}

          uv run python scripts/diagnose_failures.py \
            --input tests/fixtures/pending_year_verification.csv \
            --output diagnostic_results.json \
            --max-albums "$MAX_ALBUMS"

      - name: Upload diagnostic results
        if: steps.check.outputs.has_pending == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: diagnostic-results
          path: diagnostic_results.json
          retention-days: 30

      - name: Create GitHub issues
        if: steps.check.outputs.has_pending == 'true' && (github.event.inputs.create_issues != 'false')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          uv run python scripts/create_issue.py \
            --input diagnostic_results.json \
            --repo ${{ github.repository }}

      - name: Summary
        if: always()
        run: |
          echo "## Diagnosis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.check.outputs.has_pending }}" == "true" ]]; then
            echo "- **Pending albums:** ${{ steps.check.outputs.count }}" >> $GITHUB_STEP_SUMMARY

            if [[ -f diagnostic_results.json ]]; then
              DIAGNOSED=$(jq length diagnostic_results.json)
              echo "- **Diagnosed:** $DIAGNOSED" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No pending albums to diagnose." >> $GITHUB_STEP_SUMMARY
          fi
